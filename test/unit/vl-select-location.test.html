<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <script type="module" src="../../src/vl-select-address.js"></script>
  <script src="/node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
  <test-fixture id="vl-select-location-fixture">
    <template>
      <select is="vl-select-location"></select>
    </template>
  </test-fixture>

  <script type="module">
    import {awaitUntil} from '/node_modules/vl-ui-core/dist/vl-core.js';
    import {LambertCoordinaat} from '../../src/vl-map-search';

    suite('vl-select-location', () => {
      const sandbox = sinon.createSandbox();

      const locationGent1 = {
        Municipality: 'Gent',
        Zipcode: '9000',
        Thoroughfarename: 'Charles de Kerchovelaan',
        Housenumber: '191A',
        ID: 3021631,
        FormattedAddress: 'Charles de Kerchovelaan 191A, 9000 Gent',
        Location: {
          Lat_WGS84: 51.03991219945412,
          Lon_WGS84: 3.723601443431199,
          X_Lambert72: 104751.84,
          Y_Lambert72: 192389.4,
        },
        LocationType: 'crab_huisnummer_manueleAanduidingVanPerceel',
        BoundingBox: {
          LowerLeft: {
            Lat_WGS84: 51.03991219945412,
            Lon_WGS84: 3.723601443431199,
            X_Lambert72: 104751.84,
            Y_Lambert72: 192389.4},
          UpperRight: {
            Lat_WGS84: 51.03991219945412,
            Lon_WGS84: 3.723601443431199,
            X_Lambert72: 104751.84,
            Y_Lambert72: 192389.4,
          },
        },
      };

      const locationGent2 = {
        Municipality: 'Gent',
        Zipcode: '9000',
        Thoroughfarename: 'Charles de Kerchovelaan',
        Housenumber: '197',
        ID: 1210091,
        FormattedAddress: 'Charles de Kerchovelaan 197, 9000 Gent',
        Location: {
          Lat_WGS84: 51.0398710793381,
          Lon_WGS84: 3.7236600414926286,
          X_Lambert72: 104755.91,
          Y_Lambert72: 192384.79,
        },
        LocationType: 'crab_huisnummer_manueleAanduidingVanPerceel',
        BoundingBox: {
          LowerLeft: {
            Lat_WGS84: 51.0398710793381,
            Lon_WGS84: 3.7236600414926286,
            X_Lambert72: 104755.91,
            Y_Lambert72: 192384.79,
          },
          UpperRight: {
            Lat_WGS84: 51.0398710793381,
            Lon_WGS84: 3.7236600414926286,
            X_Lambert72: 104755.91,
            Y_Lambert72: 192384.79,
          },
        },
      };

      const locationAntwerpen1 = {
        Municipality: 'Antwerpen',
        Zipcode: null,
        Thoroughfarename: null,
        Housenumber: null,
        ID: 2,
        FormattedAddress: 'Antwerpen',
        Location: {
          Lat_WGS84: 51.26055097634139,
          Lon_WGS84: 4.358436586642045,
          X_Lambert72: 149279.48,
          Y_Lambert72: 216739.74},
        LocationType: 'crab_gemeente',
        BoundingBox: {
          LowerLeft: {
            Lat_WGS84: 51.143359370883445,
            Lon_WGS84: 4.218833610929702,
            X_Lambert72: 139508.19,
            Y_Lambert72: 203712.17,
          },
          UpperRight: {
            Lat_WGS84: 51.377571431614676,
            Lon_WGS84: 4.498743162727715,
            X_Lambert72: 159050.77,
            Y_Lambert72: 229767.3,
          },
        },
      };

      const choicesAreLoaded = (element) => [...element._choices.choiceList.children][0].innerText != 'Lokaliseer adres';

      setup((done) => {
        customElements.whenDefined('vl-select-location').then(() => done());
      });

      teardown(() => {
        sandbox.restore();
      });

      test('het data-vl-select attribuut wordt gezet zodat de zoek functionaliteit geïnitialiseerd wordt', () => {
        const element = fixture('vl-select-location-fixture');
        assert.isTrue(element.hasAttribute('data-vl-select'));
      });
    
      test('wanneer de gebruiker zoekt zullen bij Geopunt de suggesties opgehaald en gevisualiseerd worden', async () => {
        const suggestions = ['Antwerpen', 'Antwerpenlei, Brasschaat', 'Antwerpenplein, Gent', 'Antwerpenstraat, Bredene', 'Hemiksem'];
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({
            SuggestionResult: suggestions,
          }), {status: 200}));
        });
        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Suggestion?q=' + suggestions[0]).returns(response);
        const select = fixture('vl-select-location-fixture');
        await select.ready();
        select.dispatchEvent(new CustomEvent('search', {
          detail: {
            value: suggestions[0],
          },
        }));
        await awaitUntil(() => choicesAreLoaded(select));
        assert.deepEqual([...select._choices.choiceList.children].map((suggestion) => suggestion.innerText), suggestions);
      });

      test('wanneer de gebruiker een Lambert-coördinaat zoekt, zullen bij Geopunt de locaties opgehaald en gevisualiseerd worden', async () => {
        const coordinate = '104719.27, 192387.25';
        const lambertCoordinaat = LambertCoordinaat.of(coordinate);
        const value = lambertCoordinaat.toString();
        const suggestions = [locationGent1, locationGent2];
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({
            LocationResult: suggestions,
          }), {status: 200}));
        });

        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Location?c=5&xy=' + lambertCoordinaat.x + ',' + lambertCoordinaat.y ).returns(response);

        const select = fixture('vl-select-location-fixture');
        await select.ready();
        select.dispatchEvent(new CustomEvent('search', {
          detail: {
            value: value,
          },
        }));

        await awaitUntil(() => choicesAreLoaded(select));
        assert.deepEqual([...select._choices.choiceList.children].map((suggestion) => suggestion.innerText), [
          suggestions[0].FormattedAddress,
          suggestions[1].FormattedAddress,
          `Lambert-coördinaat: ${coordinate}`,
        ]);
      });

      test('er zijn default placeholders voor het zoek adres select element', async () => {
        const select = fixture('vl-select-location-fixture');
        assert.equal(select._placeholderElement.innerText, 'Lokaliseer adres');
        assert.equal(await getPlaceholderText(select), 'Zoeken op adres of coördinaat');
        assert.equal(await getNoResultsText(select), 'Geen adres gevonden');
        assert.equal(await getNoMoreOptionsText(select), 'Geen adres gevonden');
      });

    
      test('de default placeholder van het zoek adres select element kan gewijzigd worden', () => {
        const select = fixture('vl-select-location-fixture');
        let text1 = 'nieuwe tekst 1';
        select.setAttribute('data-vl-placeholder', text1);
        assert.equal(select._placeholderElement.innerText, text1);

        text1 = 'splinternieuwe tekst 1';
        select.placeholder = text1;
        assert.equal(select._placeholderElement.innerText, text1);
      });

      test('kan de geografische locatie van het geselecteerde adres opvragen', async () => {
        const value = 'Antwerpen';
        const choices = [{
          value: value,
          label: value,
        }];
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({
            LocationResult: [locationAntwerpen1],
          }, {status: 200})));
        });
        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Location?q=' + value).returns(response);
        const select = fixture('vl-select-location-fixture');
        await select.ready();
        select.choices = choices;
        select.value = choices[0].value;
        await awaitUntil(() => choicesAreLoaded(select));
        const location = await select.location;
        assert.deepEqual(location, [
          locationAntwerpen1.BoundingBox.LowerLeft.X_Lambert72,
          locationAntwerpen1.BoundingBox.LowerLeft.Y_Lambert72,
          locationAntwerpen1.BoundingBox.UpperRight.X_Lambert72,
          locationAntwerpen1.BoundingBox.UpperRight.Y_Lambert72,
        ]);
      });

      test('kan de geografische locatie van een Lambert-coördinaat opvragen', async () => {
        const fetchSpy = sandbox.spy(window, 'fetch');
        const value = '139508.19, 203712.17';
        const lambertCoordinaat = LambertCoordinaat.of(value);
        const choices = [{
          value: lambertCoordinaat,
          label: `Lambert-coördinaat: ${lambertCoordinaat.toString()}`,
        }];
        const select = fixture('vl-select-location-fixture');
        await select.ready();
        select.choices = choices;
        select.value = choices[0].value;
        await awaitUntil(() => choicesAreLoaded(select));
        const location = await select.location;
        assert.deepEqual(location, [
          lambertCoordinaat.x - 1,
          lambertCoordinaat.y - 1,
          lambertCoordinaat.x + 1,
          lambertCoordinaat.y + 1,
        ]);
        assert.isTrue(fetchSpy.notCalled);
      });

      test('kan de geografische locatie van een Lambert-coördinaat adres opvragen', async () => {
        const fetchSpy = sandbox.spy(window, 'fetch');
        const choices = [{
          value: locationAntwerpen1,
          label: locationAntwerpen1.FormattedAddress,
        }];
        const select = fixture('vl-select-location-fixture');
        await select.ready();
        select.choices = choices;
        select.value = choices[0].value;
        await awaitUntil(() => choicesAreLoaded(select));
        const location = await select.location;
        assert.deepEqual(location, [
          locationAntwerpen1.BoundingBox.LowerLeft.X_Lambert72,
          locationAntwerpen1.BoundingBox.LowerLeft.Y_Lambert72,
          locationAntwerpen1.BoundingBox.UpperRight.X_Lambert72,
          locationAntwerpen1.BoundingBox.UpperRight.Y_Lambert72,
        ]);
        assert.isTrue(fetchSpy.notCalled);
      });

      test('verstuurt een change event wanneer een choice event getriggerd wordt', (done) => {
        const select = fixture('vl-select-location-fixture');
        select.addEventListener('change', () => done());
        select.dispatchEvent(new CustomEvent('choice'));
      });

      const getNoResultsText = (select) => {
        return new Promise(async (resolve, reject) => {
          await select.ready();
          select._wrapperElement.addEventListener('click', async () => {
            sendKey(select, 'P');
            await awaitUntil(() => select._wrapperElement.querySelector('.has-no-results') != null);
            resolve(select._wrapperElement.querySelector('.has-no-results').innerText);
            sendKey(select, '');
          });
          select.focus();
        });
      };
    
      const getPlaceholderText = (select) => {
        return new Promise(async (resolve, reject) => {
          await select.ready();
          return resolve(select._wrapperElement.querySelector('input').getAttribute('placeholder'));
        });
      };

      const getNoMoreOptionsText = (select) => {
        return new Promise(async (resolve, reject) => {
          await select.ready();
          select._wrapperElement.addEventListener('click', async () => {
            sendKey(select, 'P');
            sendBackspace(select);
            await awaitUntil(() => select._wrapperElement.querySelector('.has-no-choices') != null);
            resolve(select._wrapperElement.querySelector('.has-no-choices').innerText);
          });
          select.focus();
        });
      };

      const sendBackspace = (select) => {
        sendKey(select, '\b');
      };
    
      const sendKey = (select, key) => {
        select._wrapperElement.querySelector('input').value = key.charCodeAt(0) >= 32 ? key : '';
        select._wrapperElement.querySelector('input').dispatchEvent(new KeyboardEvent('keyup', {'bubbles': true, 'keyCode': key.charCodeAt(0) || 46} ));
      };
    });
  </script>
</body>

</html>
