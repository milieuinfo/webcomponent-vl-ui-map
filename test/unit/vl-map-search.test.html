<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <script type="module" src="../../src/vl-map-all.js"></script>
  <script src="/node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
  <test-fixture id="vl-map-search-fixture">
    <template>
      <vl-map-search></vl-map-search>
    </template>
  </test-fixture>

  <test-fixture id="vl-map-with-search-fixture">
    <template>
      <vl-map>
        <vl-map-search></vl-map-search>
      </vl-map>
    </template>
  </test-fixture>

  <test-fixture id="standalone-vl-map-search-fixture">
    <template>
      <vl-map></vl-map>
      <vl-map-search></vl-map-search>
    </template>
  </test-fixture>


  <script type="module">
    import {awaitUntil} from '/node_modules/vl-ui-core/dist/vl-core.js';
    import {LambertCoordinaat, REGEX as LAMBERT_COORDINAAT_REGEX} from '../../src/lambert-coordinaat';

    suite('vl-map-search', () => {
      const sandbox = sinon.createSandbox();
      const should = chai.should();

      setup((done) => {
        customElements.whenDefined('vl-map').then(() => done());
      });

      teardown(() => {
        sandbox.restore();
      });

      test('bevat een search element met correct geconfigureerd select element als input slot in', (done) => {
        const element = fixture('vl-map-search-fixture');
        customElements.whenDefined('vl-search').then(() => {
          const searchElement = element.shadowRoot.querySelector('vl-search');
          should.exist(searchElement);
          assert.isDefined(searchElement.getAttribute('data-vl-inline'));

          const selectElement = searchElement.querySelector('select');
          should.exist(selectElement);
          assert.equal(selectElement.getAttribute('is'), 'vl-select');
          assert.isDefined(selectElement.getAttribute('data-vl-select'));
          assert.isDefined(selectElement.getAttribute('data-vl-select-deletable'));
          assert.equal(selectElement.getAttribute('data-vl-select-search-empty-text'), 'Geen adres gevonden');
          done();
        });
      });

      test('wanneer de gebruiker zoekt zullen bij geopunt de suggesties opgehaald worden', () => {
        const value = 'straat';
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({}), {status: 200}));
        });
        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Suggestion?q=' + value).returns(response);
        const element = fixture('vl-map-with-search-fixture');
        return customElements.whenDefined('vl-map').then( async () => {
          const selectElement = element.shadowRoot.querySelector('vl-map-search').shadowRoot.querySelector('select');
          selectElement.dispatchEvent(new CustomEvent('search', {
            detail: {
              value: value,
            },
          }));
          await awaitUntil(() => fetchStub.called);
        });
      });

      test('wanneer de gebruiker een Lambert-coördinaat zoekt, zullen bij geopunt de locaties opgehaald worden', () => {
        const lambertCoordinaat = LambertCoordinaat.of('104719.27, 192387.25');
        const value = lambertCoordinaat.toString();

        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({}), {status: 200}));
        });

        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Location?c=5&xy=' + lambertCoordinaat.x + ',' + lambertCoordinaat.y ).returns(response);

        const element = fixture('vl-map-with-search-fixture');
        return customElements.whenDefined('vl-map').then( async () => {
          const selectElement = element.shadowRoot.querySelector('vl-map-search').shadowRoot.querySelector('select');

          selectElement.dispatchEvent(new CustomEvent('search', {
            detail: {
              value: value,
            },
          }));

          await awaitUntil(() => fetchStub.called);
        });
      });

      test('wanneer de gebruiker een suggestie selecteert zal bij geopunt de locatie opgehaald worden', () => {
        const location = {
          LocationResult: [{
            BoundingBox: {
              LowerLeft: {
                X_Lambert72: 0,
                Y_Lambert72: 1,
              },
              UpperRight: {
                X_Lambert72: 0,
                Y_Lambert72: 1,
              },
            },
          }],
        };
        const value = 'straat';
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify(location), {status: 200}));
        });
        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Location?q=' + value).returns(response);
        const map = fixture('vl-map-with-search-fixture');
        return customElements.whenDefined('vl-map').then( async () => {
          sandbox.spy(map, 'zoomTo');
          const selectElement = map.shadowRoot.querySelector('vl-map-search').shadowRoot.querySelector('select');
          selectElement.dispatchEvent(new CustomEvent('choice', {
            detail: {
              choice: {
                value: value,
              },
            },
            bubbles: false,
            composed: false,
          }));

          await awaitUntil(() => map.zoomTo.calledWith([location.LocationResult[0].BoundingBox.LowerLeft.X_Lambert72, location.LocationResult[0].BoundingBox.LowerLeft.Y_Lambert72, location.LocationResult[0].BoundingBox.UpperRight.X_Lambert72, location.LocationResult[0].BoundingBox.UpperRight.Y_Lambert72]));
        });
      });

      test('wanneer de gebruiker een Lambert-coördinaat selecteert, zal niets opgehaald worden', () => {
        const lambertCoordinaat = LambertCoordinaat.of('104719.27, 192387.25');

        const fetchSpy = sandbox.spy(window, 'fetch');

        const map = fixture('vl-map-with-search-fixture');
        return customElements.whenDefined('vl-map').then( async () => {
          sandbox.spy(map, 'zoomToGeometry');
          const selectElement = map.shadowRoot.querySelector('vl-map-search').shadowRoot.querySelector('select');
          selectElement.dispatchEvent(new CustomEvent('choice', {
            detail: {
              choice: {
                value: lambertCoordinaat,
              },
            },
            bubbles: false,
            composed: false,
          }));

          await awaitUntil(() => fetchSpy.notCalled);
        });
      });

      test('wanneer de gebruiker een Locatie selecteert zal niets opgehaald worden', () => {
        const location = {
          BoundingBox: {
            LowerLeft: {
              X_Lambert72: 0,
              Y_Lambert72: 1,
            },
            UpperRight: {
              X_Lambert72: 0,
              Y_Lambert72: 1,
            },
          },
        };

        const fetchSpy = sandbox.spy(window, 'fetch');

        const map = fixture('vl-map-with-search-fixture');
        return customElements.whenDefined('vl-map').then( async () => {
          sandbox.spy(map, 'zoomTo');
          const selectElement = map.shadowRoot.querySelector('vl-map-search').shadowRoot.querySelector('select');
          selectElement.dispatchEvent(new CustomEvent('choice', {
            detail: {
              choice: {
                value: location,
              },
            },
            bubbles: false,
            composed: false,
          }));

          await awaitUntil(() => fetchSpy.notCalled);
        });
      });

      test('indien vl-map-search element binnen een vl-map element zit, zal dit element toegevoegd worden aan de shadow dom', (done) => {
        const element = fixture('vl-map-with-search-fixture');
        should.not.exist(element.shadowRoot.querySelector('vl-map-search'));
        customElements.whenDefined('vl-map').then(() => {
          should.exist(element.shadowRoot.querySelector('vl-map-search'));
          done();
        });
      });

      test('indien vl-map-search element niet binnen een vl-map element zit, kan de koppeling nadien manueel gebeuren', () => {
        const element = fixture('standalone-vl-map-search-fixture');
        return customElements.whenDefined('vl-map').then(() => {
          return customElements.whenDefined('vl-map-search').then(() => {
            const mapElement = element[0];
            const searchElement = element[1];
            searchElement.bindMap(mapElement);
            assert.equal(searchElement._map, mapElement);
          });
        });
      });

      test('on select callback wordt aangeroepen', (done) => {
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({LocationResult: [1, 2, 3, 4]}), {status: 200}));
        });
        const stub = sandbox.stub(window, 'fetch');
        stub.returns(response);
        const element = fixture('vl-map-with-search-fixture');
        customElements.whenDefined('vl-map-search').then(() => {
          element.shadowRoot.querySelector('vl-map-search').onSelect(() => done());
          element.shadowRoot.querySelector('vl-map-search')._selectElement.dispatchEvent(new CustomEvent('choice', {detail: {choice: {value: 'test'}}}));
        });
      });

      test('er zijn default placeholders voor het zoek adres select element', () => {
        const element = fixture('vl-map-search-fixture');
        assert.equal(element._placeholderElement.innerText, 'Lokaliseer adres');
        assert.equal(element.getTranslation('select.search_placeholder_value'), 'Gemeente, straat en huisnummer of Lambert-coördinaat');
        assert.equal(element._selectElement.getAttribute('data-vl-select-search-empty-text'), 'Geen adres gevonden');
        assert.equal(element.getTranslation('select.no_more_options'), 'Geen adres gevonden');
      });

      test('de default placeholders van het zoek adres select element kunnen gewijzigd worden', () => {
        const element = fixture('vl-map-search-fixture');
        let text1 = 'Nieuwe tekst 1';
        let text2 = 'Nieuwe tekst 2';
        let text3 = 'Nieuwe tekst 3';
        let text4 = 'Nieuwe tekst 4';
        element.setAttribute('data-vl-placeholder', text1);
        element.setAttribute('data-vl-search-placeholder', text2);
        element.setAttribute('data-vl-search-empty-text', text3);
        element.setAttribute('data-vl-search-no-results-text', text4);
        assert.equal(element._placeholderElement.innerText, text1);
        assert.equal(element.getTranslation('select.search_placeholder_value'), text2);
        assert.equal(element._selectElement.getAttribute('data-vl-select-search-empty-text'), text3);
        assert.equal(element.getTranslation('select.no_more_options'), text4);

        text1 = 'Splinternieuwe tekst 1';
        text2 = 'Splinternieuwe tekst 2';
        text3 = 'Splinternieuwe tekst 3';
        text4 = 'Splinternieuwe tekst 4';
        element.placeholder = text1;
        element.searchPlaceholder = text2;
        element.searchEmptyText = text3;
        element.searchNoResultsText = text4;
        assert.equal(element._placeholderElement.innerText, text1);
        assert.equal(element.getTranslation('select.search_placeholder_value'), text2);
        assert.equal(element._selectElement.getAttribute('data-vl-select-search-empty-text'), text3);
        assert.equal(element.getTranslation('select.no_more_options'), text4);
      });
    });

    suite('Lambert-coördinaat', () => {
      test('of - een vrije tekst, geeft "undefined"', () => {
        expect(LambertCoordinaat.of('test')).to.be.undefined;
      });

      test('of - "null", geeft "undefined"', () => {
        expect(LambertCoordinaat.of(null)).to.be.undefined;
      });

      test('of - "undefined", geeft "undefined"', () => {
        expect(LambertCoordinaat.of(undefined)).to.be.undefined;
      });

      test('of - een lege string, geeft "undefined"', () => {
        expect(LambertCoordinaat.of('')).to.be.undefined;
      });

      test('of - een geldige coördinaat, geeft een LambertCoordinaat', () => {
        const lambertCoordinaat = LambertCoordinaat.of('123456.78, 345232.04');

        expect(lambertCoordinaat).not.to.be.undefined;
        expect(lambertCoordinaat).to.deep.equal({
          _x: 123456.78,
          _y: 345232.04,
        });
        expect(lambertCoordinaat.toString()).to.be.equal('123456.78, 345232.04');
      });

      test('of - een geldige coördinaat met gehele getallen, geeft een LambertCoordinaat', () => {
        const lambertCoordinaat = LambertCoordinaat.of('123456, 34523');

        expect(lambertCoordinaat).not.to.be.undefined;
        expect(lambertCoordinaat).to.deep.equal({
          _x: 123456,
          _y: 34523,
        });
        expect(lambertCoordinaat.toString()).to.be.equal('123456, 34523');
      });

      test('of - geldige coordinaat met haakjes en gescheiden door een puntkomma, geeft een LambertCoordinaat', () => {
        const lambertCoordinaat = LambertCoordinaat.of('(123456.78; 345232.04)');

        expect(lambertCoordinaat).not.to.be.undefined;
        expect(lambertCoordinaat).to.deep.equal({
          _x: 123456.78,
          _y: 345232.04,
        });
        expect(lambertCoordinaat.toString()).to.be.equal('123456.78, 345232.04');
      });
    });

    suite('Lambert-coördinaat - RegEx', () => {
      test('Matched met: een geldige coördinaat', () => {
        const searchInput = '104719.27, 192387.25';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een x-coördinaat zonder decimaal getal', () => {
        const searchInput = '104719, 192387.25';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een x en y-coördinaat zonder decimaal getal', () => {
        const searchInput = '104719, 192387';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719');
        expect(result.groups.y).to.be.equal('192387');
      });

      test('Matched met: een y-coördinaat zonder decimaal getal', () => {
        const searchInput = '104719.27, 192387';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387');
      });

      test('Matched met: een coördinaat met gehele getallen', () => {
        const searchInput = '104, 19';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104');
        expect(result.groups.y).to.be.equal('19');
      });

      test('Matched met: een coördinaat gescheiden door een punt komma', () => {
        const searchInput = '104719.27; 192387.25';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat gescheiden door een komma', () => {
        const searchInput = '104719.27, 192387.25';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met haakjes', () => {
        const searchInput = '(104719.27; 192387.25)';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met enkel een starthaakje', () => {
        const searchInput = '(104719.27; 192387.25';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met enkel een eindhaakje', () => {
        const searchInput = '104719.27; 192387.25)';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met spaties ervoor', () => {
        const searchInput = '     104719.27; 192387.25)';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat zonder spatie na het scheidingsteken', () => {
        const searchInput = '     104719.27;192387.25)';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met meerdere spaties na het scheidingsteken', () => {
        const searchInput = '104719.27;     192387.25)';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met 3 cijfers na de komma', () => {
        const searchInput = '104719.271, 192387.252';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched met: een coördinaat met 5 cijfers na de komma', () => {
        const searchInput = '104719.27123, 192387.25456';
        const result = searchInput.match(LAMBERT_COORDINAAT_REGEX);

        expect(result[0]).to.be.equal(searchInput);
        expect(result.groups.x).to.be.equal('104719.27');
        expect(result.groups.y).to.be.equal('192387.25');
      });

      test('Matched niet met: een vrije tekst', () => {
        expect('Gent'.match(LAMBERT_COORDINAAT_REGEX)).to.be.null;
      });

      test('Matched niet met: een lege string', () => {
        expect(''.match(LAMBERT_COORDINAAT_REGEX)).to.be.null;
      });

      test('Matched niet met: een spatie', () => {
        expect(' '.match(LAMBERT_COORDINAAT_REGEX)).to.be.null;
      });
    });

  </script>
</body>

</html>
