<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../web-component-tester/browser.js"></script>

    <script type="module" src="../../src/vl-map-all.js"></script>
    <script src="/node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
<test-fixture id="vl-map-wfs-layer-fixture">
    <template>
        <vl-map>
            <vl-map-wfs-layer data-vl-name="foobar"
                              data-vl-url="http://dummy/wfs"
                              data-vl-layers="layer1,layer2"></vl-map-wfs-layer>
        </vl-map>
    </template>
</test-fixture>
<test-fixture id="vl-map-wfs-layer-fixture-with-query-params-in-url">
    <template>
        <vl-map>
            <vl-map-wfs-layer data-vl-name="foobar"
                              data-vl-url="http://dummy/wfs?foo=bar"
                              data-vl-layers="layer1,layer2"></vl-map-wfs-layer>
        </vl-map>
    </template>
</test-fixture>
<test-fixture id="vl-map-wfs-layer-fixture-visibility">
    <template>
        <vl-map>
            <vl-map-wfs-layer data-vl-name="foobar"
                              data-vl-url="http://dummy/wfs"
                              data-vl-layers="layer1,layer2"
                              data-vl-min-resolution="10"
                              data-vl-max-resolution="1000"></vl-map-wfs-layer>
        </vl-map>
    </template>
</test-fixture>
<test-fixture id="vl-map-wfs-layer-fixture-with-style">
    <template>
        <vl-map>
            <vl-map-wfs-layer data-vl-name="foobar"
                              data-vl-url="http://dummy/wfs"
                              data-vl-layers="layer1,layer2"
                              data-vl-min-resolution="10"
                              data-vl-max-resolution="1000">
                <vl-map-layer-style data-vl-color="rgba(44,55,66,0.77)"></vl-map-layer-style>
            </vl-map-wfs-layer>
        </vl-map>
    </template>
</test-fixture>

<script type="module">
  import {
    testOpvragenVanTitel,
    testVisibility,
    testVisibilityAtResolution,
    testIDs,
    testToevoegingAanMap,
  } from './vl-map-layer-util.js';
  import {OlProjection} from '/node_modules/vl-mapactions/dist/vl-mapactions.js';

  suite('vl-map-wfs-layer', () => {
    const sandbox = sinon.createSandbox();
    const should = chai.should();

    setup(async () => {
      await customElements.whenDefined('vl-map-wfs-layer');
      await customElements.whenDefined('vl-map-layer-circle-style');
    });

    teardown(() => {
      sandbox.restore();
    });

    testToevoegingAanMap(() => fixture('vl-map-wfs-layer-fixture-visibility'));
    testIDs(() => fixture('vl-map-wfs-layer-fixture'), 1);
    testVisibility(() => fixture('vl-map-wfs-layer-fixture'));
    testVisibilityAtResolution(() => fixture('vl-map-wfs-layer-fixture'));
    testVisibilityAtResolution(() => fixture('vl-map-wfs-layer-fixture-visibility'), 10, 1000);
    testOpvragenVanTitel(() => fixture('vl-map-wfs-layer-fixture'), 'foobar');

    test('wfs layer kan toegevoegd worden aan een map met de correcte configuratie', async () => {
      const mapElement = fixture('vl-map-wfs-layer-fixture');
      const layerElement = mapElement.querySelector('vl-map-wfs-layer');
      const projection = new OlProjection({
        code: 'EPSG:31370',
      });

      await mapElement.ready;
      should.exist(layerElement.layer);
      const layer = layerElement.layer;
      assert.equal(
          layer.getSource().getUrl()([1.2, 3.4, 5.6, 7.8], 123, projection).toString(),
          'http://dummy/wfs?request=GetFeature&typename=layer1%2Clayer2&bbox=1.2%2C3.4%2C5.6%2C7.8&srsname=EPSG%3A31370&outputFormat=application%2Fjson',
      );
    });

    test('de query params in de geconfigureerde wfs url worden gelaten as-is indien we ze niet moeten overschrijven', async () => {
      const mapElement = fixture('vl-map-wfs-layer-fixture-with-query-params-in-url');
      const layerElement = mapElement.querySelector('vl-map-wfs-layer');
      const projection = new OlProjection({
        code: 'EPSG:31370',
      });

      await mapElement.ready;
      should.exist(layerElement.layer);
      const layer = layerElement.layer;
      assert.equal(
          layer.getSource().getUrl()([1.2, 3.4, 5.6, 7.8], 123, projection).toString(),
          'http://dummy/wfs?foo=bar&request=GetFeature&typename=layer1%2Clayer2&bbox=1.2%2C3.4%2C5.6%2C7.8&srsname=EPSG%3A31370&outputFormat=application%2Fjson',
      );
    });

    test('er wordt stijl toegepast op de layer', async () => {
      const mapElement = fixture('vl-map-wfs-layer-fixture-with-style');
      const layerElement = mapElement.querySelector('vl-map-wfs-layer');

      await mapElement.ready;
      should.exist(layerElement.layer);
      const layer = layerElement.layer;
      const style = layer.getStyle()({get: () => {}})[0];
      assert.equal(style.getFill().getColor(), 'rgba(44,55,66,0.77)');
    });
  });
</script>
</body>

</html>
