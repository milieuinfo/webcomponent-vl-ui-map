<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>

  <script type="module" src="../../src/vl-map-all.js"></script>
  <script src="/node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
  <test-fixture id="vl-select-address-fixture">
    <template>
      <select is="vl-select-address"></select>
    </template>
  </test-fixture>

  <script type="module">
    import {awaitUntil} from '/node_modules/vl-ui-core/dist/vl-core.js';
    import {LambertCoordinaat} from '../../src/vl-map-search';

    suite('vl-select-address', () => {
      const sandbox = sinon.createSandbox();

      setup((done) => {
        customElements.whenDefined('vl-select-address').then(() => done());
      });

      teardown(() => {
        sandbox.restore();
      });
    
      test('wanneer de gebruiker zoekt zullen bij Geopunt de suggesties opgehaald en gevisualiseerd worden', async () => {
        const value = 'straat';
        const suggestions = ['Antwerpen', 'Antwerpenlei, Brasschaat', 'Antwerpenplein, Gent', 'Antwerpenstraat, Bredene', 'Hemiksem'];
        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({
            SuggestionResult: suggestions,
          }), {status: 200}));
        });
        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Suggestion?q=' + value).returns(response);
        const select = fixture('vl-select-address-fixture');
        await select.ready();
        select.dispatchEvent(new CustomEvent('search', {
          detail: {
            value: value,
          },
        }));
        await awaitUntil(() => fetchStub.called);
        await awaitUntil(() => select._choices.choiceList.children.length == suggestions.length);
        assert.deepEqual([...select._choices.choiceList.children].map((suggestion) => suggestion.innerText), suggestions);
      });

      test('wanneer de gebruiker een Lambert-coördinaat zoekt, zullen bij Geopunt de locaties opgehaald en gevisualiseerd worden', async () => {
        const coordinate = '104719.27, 192387.25';
        const lambertCoordinaat = LambertCoordinaat.of(coordinate);
        const value = lambertCoordinaat.toString();
        const suggestions = [{
          'Municipality': 'Gent',
          'Zipcode': '9000',
          'Thoroughfarename': 'Charles de Kerchovelaan',
          'Housenumber': '191A',
          'ID': 3021631,
          'FormattedAddress': 'Charles de Kerchovelaan 191A, 9000 Gent',
          'Location': {
            'Lat_WGS84': 51.03991219945412,
            'Lon_WGS84': 3.723601443431199,
            'X_Lambert72': 104751.84,
            'Y_Lambert72': 192389.4,
          },
          'LocationType': 'crab_huisnummer_manueleAanduidingVanPerceel',
          'BoundingBox': {
            'LowerLeft': {
              'Lat_WGS84': 51.03991219945412,
              'Lon_WGS84': 3.723601443431199,
              'X_Lambert72': 104751.84,
              'Y_Lambert72': 192389.4},
            'UpperRight': {
              'Lat_WGS84': 51.03991219945412,
              'Lon_WGS84': 3.723601443431199,
              'X_Lambert72': 104751.84,
              'Y_Lambert72': 192389.4,
            },
          },
        }, {
          'Municipality': 'Gent',
          'Zipcode': '9000',
          'Thoroughfarename': 'Charles de Kerchovelaan',
          'Housenumber': '197',
          'ID': 1210091,
          'FormattedAddress': 'Charles de Kerchovelaan 197, 9000 Gent',
          'Location': {
            'Lat_WGS84': 51.0398710793381,
            'Lon_WGS84': 3.7236600414926286,
            'X_Lambert72': 104755.91,
            'Y_Lambert72': 192384.79,
          },
          'LocationType': 'crab_huisnummer_manueleAanduidingVanPerceel',
          'BoundingBox': {
            'LowerLeft': {
              'Lat_WGS84': 51.0398710793381,
              'Lon_WGS84': 3.7236600414926286,
              'X_Lambert72': 104755.91,
              'Y_Lambert72': 192384.79,
            },
            'UpperRight': {
              'Lat_WGS84': 51.0398710793381,
              'Lon_WGS84': 3.7236600414926286,
              'X_Lambert72': 104755.91,
              'Y_Lambert72': 192384.79,
            },
          },
        }];

        const response = new Promise((resolve, reject) => {
          resolve(new Response(JSON.stringify({
            LocationResult: suggestions,
          }), {status: 200}));
        });

        const fetchStub = sandbox.stub(window, 'fetch');
        fetchStub.withArgs('https://loc.geopunt.be/v4/Location?c=5&xy=' + lambertCoordinaat.x + ',' + lambertCoordinaat.y ).returns(response);

        const select = fixture('vl-select-address-fixture');
        await select.ready();
        select.dispatchEvent(new CustomEvent('search', {
          detail: {
            value: value,
          },
        }));

        await awaitUntil(() => fetchStub.called);
        await awaitUntil(() => select._choices.choiceList.children.length == suggestions.length+1);
        assert.deepEqual([...select._choices.choiceList.children].map((suggestion) => suggestion.innerText), [
          suggestions[0].FormattedAddress,
          suggestions[1].FormattedAddress,
          `Lambert-coördinaat: ${coordinate}`,
        ]);
      });

      test('er zijn default placeholders voor het zoek adres select element', () => {
        const select = fixture('vl-select-address-fixture');
        assert.equal(select._placeholderElement.innerText, 'Lokaliseer adres');
        assert.equal(select.getTranslation('select.search_placeholder_value'), 'Zoeken op adres of coördinaat');
        assert.equal(select.getAttribute('data-vl-select-search-empty-text'), 'Geen adres gevonden');
        assert.equal(select.getTranslation('select.no_more_options'), 'Geen adres gevonden');
      });

      test('de default placeholders van het zoek adres select element kunnen gewijzigd worden', () => {
        const select = fixture('vl-select-address-fixture');
        let text1 = 'Nieuwe tekst 1';
        let text2 = 'Nieuwe tekst 2';
        let text3 = 'Nieuwe tekst 3';
        let text4 = 'Nieuwe tekst 4';
        select.setAttribute('data-vl-placeholder', text1);
        select.setAttribute('data-vl-search-placeholder', text2);
        select.setAttribute('data-vl-search-empty-text', text3);
        select.setAttribute('data-vl-search-no-results-text', text4);
        assert.equal(select._placeholderElement.innerText, text1);
        assert.equal(select.getTranslation('select.search_placeholder_value'), text2);
        assert.equal(select.getAttribute('data-vl-select-search-empty-text'), text3);
        assert.equal(select.getTranslation('select.no_more_options'), text4);

        text1 = 'Splinternieuwe tekst 1';
        text2 = 'Splinternieuwe tekst 2';
        text3 = 'Splinternieuwe tekst 3';
        text4 = 'Splinternieuwe tekst 4';
        select.placeholder = text1;
        select.searchPlaceholder = text2;
        select.searchEmptyText = text3;
        select.searchNoResultsText = text4;
        assert.equal(select._placeholderElement.innerText, text1);
        assert.equal(select.getTranslation('select.search_placeholder_value'), text2);
        assert.equal(select.getAttribute('data-vl-select-search-empty-text'), text3);
        assert.equal(select.getTranslation('select.no_more_options'), text4);
      });
    });
  </script>
</body>

</html>
