<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../../web-component-tester/browser.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>

  <script type="module" src="../../src/vl-select.src.js"></script>
</head>

<body>
  <test-fixture id="vl-select-fixture">
    <template>
      <select id="select-1" is="vl-select"/>
    </template>
  </test-fixture>

  <test-fixture id="vl-select-auto-dress-fixture">
    <template>
      <select id="select-2" is="vl-select" data-vl-select/>
    </template>
  </test-fixture>

  <test-fixture id="vl-select-with-options-fixture">
    <template>
      <select id="select-3" is="vl-select" data-vl-select>
        <option value="België">België</option>
        <option value="Duitsland">Duitsland</option>
        <option value="Frankrijk">Frankrijk</option>
        <option value="Nederland">Nederland</option>
        <option value="Italië">Italië</option>
      </select>
    </template>
  </test-fixture>

  <script>
    suite('vl-select', () => {
      const sandbox = sinon.createSandbox();

      setup((done) => {
        customElements.whenDefined('vl-select').then(() => {
          sandbox.spy(window.vl.select, 'dress');
          sandbox.spy(window.vl.select, 'undress');
          sandbox.spy(window.vl.select, 'enable');
          sandbox.spy(window.vl.select, 'disable');
          sandbox.spy(window.vl.select, 'removeActive');
          sandbox.spy(window.vl.select, 'showDropdown');
          sandbox.spy(window.vl.select, 'hideDropdown');
          done();
        });
      });

      teardown(() => {
        sandbox.restore();
      });

      test('heeft de vl-select class', () => {
        const element = fixture('vl-select-fixture');
        assert.isTrue(element.classList.contains('vl-select'));
      });

      test('krijgt de juiste class wanneer het element een correct attribuut bevat', () => {
        const element = fixture('vl-select-fixture');
        ['block', 'error', 'success', 'disabled'].forEach((attribuut) => {
          assert.isFalse(element.classList.contains('vl-select--' + attribuut));
          element.setAttribute(attribuut, '');
          assert.isTrue(element.classList.contains('vl-select--' + attribuut));
          element.removeAttribute(attribuut);
          assert.isFalse(element.classList.contains('vl-select--' + attribuut));
        });
      });

      test('krijgt geen class wanneer het veld een onbeschikbaar attribuut bevat', () => {
        const element = fixture('vl-select-fixture');
        const attribuut = 'onbeschikbaarattribuut';
        element.setAttribute(attribuut, '');
        assert.isFalse(element.classList.contains('vl-select--' + attribuut));
      });

      test('de dress methode callt vl.select.dress', (done) => {
        const element = fixture('vl-select-fixture');
        element.addEventListener(element.readyEvent, () => {
          assert(window.vl.select.dress.calledWith(element));
          done();
        });
        element.dress();
      });

      test('de dress methode callt vl.select.dress niet als dressed attribuut al gezet is', () => {
        const element = fixture('vl-select-fixture');
        debugger;
        element.setAttribute('data-vl-select-dressed', 'true');
        element.dress();
        assert(window.vl.select.dress.notCalled);
      });

      test('de dress methode met params callt vl.select.dress met params', (done) => {
        const element = fixture('vl-select-fixture');
        let params = { callbackFn: () => { } };
        element.addEventListener(element.readyEvent, () => {
          assert(window.vl.select.dress.calledWith(element, params));
          done();
        });
        element.dress(params);
      });

      test('de undress methode callt vl.select.undress niet als dressed atribuut niet is gezet', () => {
        const element = fixture('vl-select-fixture');
        element.undress();
        assert(window.vl.select.undress.notCalled);
      });

      test('de undress methode callt vl.select.undress met de choices instantie enkel als dressed atribuut is gezet', (done) => {
        const element = fixture('vl-select-fixture');
        element.addEventListener(element.readyEvent, () => {
          const selectInstance = vl.select.selectInstances.find((instance) => {
            return instance.element === element;
          });
          element.undress();
          assert(window.vl.select.undress.calledWith(selectInstance));
          done();
        });
        element.dress();
      });

      test('de enable methode callt vl.select.enable', () => {
        const element = fixture('vl-select-fixture');
        element.enable();
        assert(window.vl.select.enable.calledWith(element));
      });

      test('de disable methode callt vl.select.enable', () => {
        const element = fixture('vl-select-fixture');
        element.disable();
        assert(window.vl.select.disable.calledWith(element));
      });

      test('de removeActive methode callt vl.select.removeActive', () => {
        const element = fixture('vl-select-fixture');
        element.removeActive();
        assert(window.vl.select.removeActive.calledWith(element));
      });

      test('de showDropdown methode callt vl.select.showDropdown', () => {
        const element = fixture('vl-select-fixture');
        element.showDropdown();
        assert(window.vl.select.showDropdown.calledWith(element));
      });

      test('de hideDropdown methode callt vl.select.hideDropdown', () => {
        const element = fixture('vl-select-fixture');
        element.hideDropdown();
        assert(window.vl.select.hideDropdown.calledWith(element));
      });

      test('de mogelijkheden kunnen achteraf nog bepaald worden', (done) => {
        const element = fixture('vl-select-auto-dress-fixture');
        element.addEventListener(element.readyEvent, () => {
          const selectInstance = vl.select.selectInstances.find((instance) => {
            return instance.element === element;
          });
          sandbox.spy(selectInstance, 'setChoices');
          const data = [{
            value: 'test value',
            label: 'test label'
          }];
          element.choices = data;
          assert(selectInstance.setChoices.calledWith(data, 'value', 'label', true));
          done();
        });
      });

      test('het zetten van de sortFilter zorgt er voor de choices config aangepast worden met een sortFilter', (done) => {
        const element = fixture('vl-select-auto-dress-fixture');
        element.addEventListener(element.readyEvent, () => {
          const sortFn = (item1, item2) => item1.id > item2.id;
          element.sortFilter = sortFn;
          const selectInstance = vl.select.selectInstances.find((instance) => {
            return instance.element === element;
          });
          assert.equal(selectInstance.config.sortFilter, sortFn);
          done();
        });
      });

      test('bij het toevoegen van een select element aan de DOM zal de dress functie aangeroepen worden zodat de select functionaliteit geactiveerd wordt', (done) => {
        const element = document.createElement('select', { is: 'vl-select' });
        element.setAttribute('data-vl-select', '');
        document.body.appendChild(element);
        element.addEventListener(element.readyEvent, () => {
          assert(window.vl.select.dress.called);
          done();
        });
      });

      test('de dress functie wordt maar 1 keer aangeroepen per select element', (done) => {
        const element = fixture('vl-select-auto-dress-fixture');
        element.addEventListener(element.readyEvent, () => {
          assert.lengthOf(vl.select.selectInstances.filter((instance) => {
            return instance.element === element;
          }), 1);
          done();
        });
      });

      test('de undress functie zorgt er ook voor dat de select instance verwijderd wordt', (done) => {
        const element = fixture('vl-select-fixture');
        element.addEventListener(element.readyEvent, () => {
          element.undress();
          assert.lengthOf(vl.select.selectInstances.filter((instance) => {
            return instance.element === element;
          }), 0);
          done();
        });
        element.dress();
      });

      test('de geselecteerde keuze kan gezet en opgevraagd worden', (done) => {
        const element = fixture('vl-select-with-options-fixture');
        element.addEventListener(element.readyEvent, () => {
          assert.equal(element.value, 'België');
          element.value = 'Duitsland';
          assert.equal(element.value, 'Duitsland');
          done();
        });
      });

      test('wanneer het vl-select element volledig klaar is zal het een ready event versturen', (done) => {
        const element1 = fixture('vl-select-fixture');
        element1.addEventListener(element1.readyEvent, () => {
          const element2 = fixture('vl-select-auto-dress-fixture');
          element2.addEventListener(element2.readyEvent, () => {
            done();
          });
        });
        element1.dress();
      });

      test('wanneer het vl-select element volledig klaar is resolved de ready functie', (done) => {
        const element1 = fixture('vl-select-fixture');
        element1.dress();
        element1.ready().then(() => done());
      });

    });
  </script>
</body>

</html>
